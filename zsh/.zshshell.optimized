# ============================================================================
# è‡ªå®šç¾© Shell å‡½æ•¸é›†åˆ - åŸºæ–¼ fzf çš„å¢å¼·å·¥å…·
# ç‰ˆæœ¬: 2.0 (å„ªåŒ–ç‰ˆ)
# ============================================================================

# ============================================================================
# TMUX ç®¡ç†å·¥å…·
# ============================================================================

# ftm - å‰µå»ºæ–° tmux session æˆ–åˆ‡æ›åˆ°ç¾æœ‰ session
# ç”¨æ³•: ftm [session_name]
# å¦‚æœæä¾› session_nameï¼Œç›´æ¥åˆ‡æ›æˆ–å‰µå»ºï¼›å¦å‰‡ä½¿ç”¨ fzf é¸æ“‡
ftm() {
    # æª¢æŸ¥ tmux æ˜¯å¦å®‰è£
    if ! command -v tmux >/dev/null 2>&1; then
        echo "éŒ¯èª¤: tmux æœªå®‰è£" >&2
        return 1
    fi

    local change_cmd
    [[ -n "$TMUX" ]] && change_cmd="switch-client" || change_cmd="attach-session"
    
    # å¦‚æœæä¾›äº†åƒæ•¸ï¼Œç›´æ¥è™•ç†
    if [[ $# -gt 0 ]]; then
        local session_name="$1"
        if tmux has-session -t "$session_name" 2>/dev/null; then
            tmux $change_cmd -t "$session_name"
        else
            echo "å‰µå»ºæ–° session: $session_name"
            tmux new-session -d -s "$session_name" && tmux $change_cmd -t "$session_name"
        fi
        return
    fi
    
    # ä½¿ç”¨ fzf é¸æ“‡ session
    local sessions
    sessions=$(tmux list-sessions -F "#{session_name}: #{session_windows} windows (#{session_attached} attached)" 2>/dev/null)
    
    if [[ -z "$sessions" ]]; then
        echo "æ²’æœ‰ç¾æœ‰çš„ tmux sessionï¼Œå‰µå»ºæ–°çš„ session..."
        read -p "è¼¸å…¥æ–° session åç¨± (é è¨­: main): " session_name
        session_name=${session_name:-main}
        tmux new-session -d -s "$session_name" && tmux $change_cmd -t "$session_name"
        return
    fi
    
    local selected_session
    selected_session=$(echo "$sessions" | fzf \
        --height=40% \
        --border \
        --prompt="é¸æ“‡ tmux session: " \
        --preview="tmux list-windows -t {1} -F '#{window_index}: #{window_name} #{window_active}'" \
        --preview-window=right:50% \
        | cut -d: -f1)
    
    if [[ -n "$selected_session" ]]; then
        tmux $change_cmd -t "$selected_session"
    else
        echo "æœªé¸æ“‡ä»»ä½• session"
    fi
}

# fs - å¿«é€Ÿåˆ‡æ› tmux session (ç°¡åŒ–ç‰ˆ)
# ç”¨æ³•: fs [FUZZY_PATTERN]
fs() {
    if ! command -v tmux >/dev/null 2>&1; then
        echo "éŒ¯èª¤: tmux æœªå®‰è£" >&2
        return 1
    fi

    local session
    session=$(tmux list-sessions -F "#{session_name}" 2>/dev/null | \
        fzf --query="$1" --select-1 --exit-0 --height=40% --border)
    
    if [[ -n "$session" ]]; then
        tmux switch-client -t "$session"
    else
        echo "æœªæ‰¾åˆ°åŒ¹é…çš„ session"
    fi
}

# ============================================================================
# æª”æ¡ˆæœå°‹èˆ‡ç·¨è¼¯å·¥å…·
# ============================================================================

# vg - ä½¿ç”¨ ripgrep æœå°‹ä¸¦ç”¨ç·¨è¼¯å™¨é–‹å•Ÿæª”æ¡ˆ
# ç”¨æ³•: vg [æœå°‹æ¨¡å¼] [å…¶ä»– rg åƒæ•¸]
vg() {
    if [[ $# -eq 0 ]]; then
        echo "ç”¨æ³•: vg <æœå°‹æ¨¡å¼> [å…¶ä»– rg åƒæ•¸]"
        echo "ç¯„ä¾‹: vg 'function' --type js"
        return 1
    fi

    if ! command -v rg >/dev/null 2>&1; then
        echo "éŒ¯èª¤: ripgrep (rg) æœªå®‰è£" >&2
        return 1
    fi

    local file line
    local result=$(rg --color=always --line-number --no-heading --smart-case "$@" | \
        fzf --ansi \
            --height=60% \
            --border \
            --prompt="é¸æ“‡æª”æ¡ˆ: " \
            --delimiter=: \
            --preview="bat --color=always --highlight-line {2} {1}" \
            --preview-window=right:60%:+{2}+3/2 \
            --bind="enter:become(echo {1}:{2})")
    
    if [[ -n "$result" ]]; then
        file=$(echo "$result" | cut -d: -f1)
        line=$(echo "$result" | cut -d: -f2)
        
        # æ ¹æ“šç·¨è¼¯å™¨é¡å‹é–‹å•Ÿæª”æ¡ˆä¸¦è·³åˆ°æŒ‡å®šè¡Œ
        case "${EDITOR:-nvim}" in
            nvim|vim)
                ${EDITOR:-nvim} "+$line" "$file"
                ;;
            code)
                code --goto "$file:$line"
                ;;
            *)
                ${EDITOR:-nvim} "$file"
                ;;
        esac
    fi
}

# ff - ä½¿ç”¨ fd æœå°‹æª”æ¡ˆä¸¦é–‹å•Ÿ
# ç”¨æ³•: ff [æœå°‹æ¨¡å¼]
ff() {
    if ! command -v fd >/dev/null 2>&1; then
        echo "éŒ¯èª¤: fd æœªå®‰è£" >&2
        return 1
    fi

    local file
    file=$(fd --type f --hidden --follow --exclude .git . | \
        fzf --query="$1" \
            --height=60% \
            --border \
            --prompt="é¸æ“‡æª”æ¡ˆ: " \
            --preview="bat --color=always --style=numbers {}" \
            --preview-window=right:60%)
    
    if [[ -n "$file" ]]; then
        ${EDITOR:-nvim} "$file"
    fi
}

# fcd - ä½¿ç”¨ fd æœå°‹ç›®éŒ„ä¸¦åˆ‡æ›
# ç”¨æ³•: fcd [æœå°‹æ¨¡å¼]
fcd() {
    if ! command -v fd >/dev/null 2>&1; then
        echo "éŒ¯èª¤: fd æœªå®‰è£" >&2
        return 1
    fi

    local dir
    dir=$(fd --type d --hidden --follow --exclude .git . | \
        fzf --query="$1" \
            --height=40% \
            --border \
            --prompt="é¸æ“‡ç›®éŒ„: " \
            --preview="eza --tree --level=2 --color=always {}" \
            --preview-window=right:50%)
    
    if [[ -n "$dir" ]]; then
        cd "$dir" && echo "å·²åˆ‡æ›åˆ°: $(pwd)"
    fi
}

# ============================================================================
# ç¨‹åºç®¡ç†å·¥å…·
# ============================================================================

# fkill - ä½¿ç”¨ fzf é¸æ“‡ä¸¦çµ‚æ­¢ç¨‹åº
# ç”¨æ³•: fkill [ä¿¡è™Ÿç·¨è™Ÿï¼Œé è¨­ç‚º 9]
fkill() {
    local signal=${1:-9}
    
    # ç²å–ç¨‹åºåˆ—è¡¨ï¼Œæ’é™¤æ¨™é¡Œè¡Œ
    local processes
    processes=$(ps -eo pid,ppid,user,%cpu,%mem,command --sort=-%cpu | sed 1d)
    
    if [[ -z "$processes" ]]; then
        echo "æœªæ‰¾åˆ°ä»»ä½•ç¨‹åº"
        return 1
    fi
    
    local selected_pids
    selected_pids=$(echo "$processes" | \
        fzf --multi \
            --height=60% \
            --border \
            --prompt="é¸æ“‡è¦çµ‚æ­¢çš„ç¨‹åº (å¯å¤šé¸): " \
            --header="PID    PPID   USER     %CPU  %MEM  COMMAND" \
            --preview="echo {}" \
            --preview-window=up:3 \
            | awk '{print $1}')
    
    if [[ -n "$selected_pids" ]]; then
        echo "å°‡è¦çµ‚æ­¢çš„ç¨‹åº PID: $selected_pids"
        read -p "ç¢ºèªçµ‚æ­¢é€™äº›ç¨‹åºå—? (y/N): " confirm
        if [[ "$confirm" =~ ^[Yy]$ ]]; then
            echo "$selected_pids" | xargs kill -"$signal"
            echo "å·²ç™¼é€ä¿¡è™Ÿ $signal åˆ°é¸å®šçš„ç¨‹åº"
        else
            echo "å·²å–æ¶ˆæ“ä½œ"
        fi
    else
        echo "æœªé¸æ“‡ä»»ä½•ç¨‹åº"
    fi
}

# ============================================================================
# Docker ç®¡ç†å·¥å…·
# ============================================================================

# fdim - ä½¿ç”¨ fzf é¸æ“‡ä¸¦åˆªé™¤ Docker æ˜ åƒ
# ç”¨æ³•: fdim
fdim() {
    if ! command -v docker >/dev/null 2>&1; then
        echo "éŒ¯èª¤: Docker æœªå®‰è£" >&2
        return 1
    fi

    local images
    images=$(docker image ls --format "table {{.Repository}}\t{{.Tag}}\t{{.ID}}\t{{.Size}}\t{{.CreatedAt}}")
    
    if [[ $(echo "$images" | wc -l) -le 1 ]]; then
        echo "æ²’æœ‰æ‰¾åˆ° Docker æ˜ åƒ"
        return 1
    fi
    
    local selected_images
    selected_images=$(echo "$images" | sed 1d | \
        fzf --multi \
            --height=60% \
            --border \
            --prompt="é¸æ“‡è¦åˆªé™¤çš„æ˜ åƒ (å¯å¤šé¸): " \
            --header="REPOSITORY    TAG    IMAGE ID    SIZE    CREATED" \
            --preview="docker image inspect {3} --format='{{json .}}' | jq -r '.Config.Env[]?' 2>/dev/null || echo 'No environment info'" \
            --preview-window=right:40% \
            | awk '{print $3}')
    
    if [[ -n "$selected_images" ]]; then
        echo "å°‡è¦åˆªé™¤çš„æ˜ åƒ ID:"
        echo "$selected_images"
        read -p "ç¢ºèªåˆªé™¤é€™äº›æ˜ åƒå—? (y/N): " confirm
        if [[ "$confirm" =~ ^[Yy]$ ]]; then
            echo "$selected_images" | xargs docker image rm -f
            echo "æ˜ åƒåˆªé™¤å®Œæˆ"
        else
            echo "å·²å–æ¶ˆæ“ä½œ"
        fi
    else
        echo "æœªé¸æ“‡ä»»ä½•æ˜ åƒ"
    fi
}

# fdc - ä½¿ç”¨ fzf é¸æ“‡ä¸¦ç®¡ç† Docker å®¹å™¨
# ç”¨æ³•: fdc [action] (action: start, stop, restart, remove, logs, exec)
fdc() {
    if ! command -v docker >/dev/null 2>&1; then
        echo "éŒ¯èª¤: Docker æœªå®‰è£" >&2
        return 1
    fi

    local action=${1:-"select"}
    local containers
    containers=$(docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Image}}\t{{.Ports}}")
    
    if [[ $(echo "$containers" | wc -l) -le 1 ]]; then
        echo "æ²’æœ‰æ‰¾åˆ° Docker å®¹å™¨"
        return 1
    fi
    
    local selected_container
    selected_container=$(echo "$containers" | sed 1d | \
        fzf --height=60% \
            --border \
            --prompt="é¸æ“‡å®¹å™¨: " \
            --header="NAME    STATUS    IMAGE    PORTS" \
            --preview="docker inspect {1} --format='{{json .State}}' | jq -r ." \
            --preview-window=right:40% \
            | awk '{print $1}')
    
    if [[ -n "$selected_container" ]]; then
        case "$action" in
            "start") docker start "$selected_container" ;;
            "stop") docker stop "$selected_container" ;;
            "restart") docker restart "$selected_container" ;;
            "remove") docker rm -f "$selected_container" ;;
            "logs") docker logs -f "$selected_container" ;;
            "exec") docker exec -it "$selected_container" /bin/bash ;;
            *) echo "å®¹å™¨: $selected_container" ;;
        esac
    else
        echo "æœªé¸æ“‡ä»»ä½•å®¹å™¨"
    fi
}

# ============================================================================
# ç¶²è·¯å·¥å…·
# ============================================================================

# myip - é¡¯ç¤ºæœ¬æ©Ÿå’Œå…¬ç¶² IP åœ°å€
myip() {
    echo "æ­£åœ¨ç²å– IP åœ°å€è³‡è¨Š..."
    
    # æœ¬æ©Ÿ IP (æ”¯æ´å¤šç¨®ç¶²å¡)
    local local_ips
    local_ips=$(ifconfig | grep -E "inet [0-9]" | grep -v "127.0.0.1" | awk '{print $2}')
    
    # å…¬ç¶² IP (ä½¿ç”¨å¤šå€‹æœå‹™ä½œç‚ºå‚™é¸)
    local public_ip
    for service in "https://api.ipify.org" "https://ifconfig.me" "https://icanhazip.com"; do
        public_ip=$(curl -s --max-time 5 "$service" 2>/dev/null)
        if [[ -n "$public_ip" ]]; then
            break
        fi
    done
    
    # é¡¯ç¤ºçµæœ
    echo ""
    echo "ğŸŒ IP åœ°å€è³‡è¨Š:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    if [[ -n "$local_ips" ]]; then
        echo "ğŸ  æœ¬æ©Ÿ IP:"
        while IFS= read -r ip; do
            echo "   $ip"
        done <<< "$local_ips"
    else
        echo "ğŸ  æœ¬æ©Ÿ IP: æœªæ‰¾åˆ°"
    fi
    
    echo ""
    if [[ -n "$public_ip" ]]; then
        echo "ğŸŒ å…¬ç¶² IP: $public_ip"
        
        # ç²å–åœ°ç†ä½ç½®è³‡è¨Š (å¯é¸)
        if command -v curl >/dev/null 2>&1; then
            local geo_info
            geo_info=$(curl -s "http://ip-api.com/json/$public_ip" 2>/dev/null | \
                jq -r '"\(.country) \(.regionName) \(.city)"' 2>/dev/null)
            if [[ -n "$geo_info" && "$geo_info" != "null null null" ]]; then
                echo "ğŸ“ ä½ç½®: $geo_info"
            fi
        fi
    else
        echo "ğŸŒ å…¬ç¶² IP: ç„¡æ³•ç²å– (è«‹æª¢æŸ¥ç¶²è·¯é€£æ¥)"
    fi
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

# ============================================================================
# Git å·¥å…·
# ============================================================================

# fgb - ä½¿ç”¨ fzf é¸æ“‡ä¸¦åˆ‡æ› Git åˆ†æ”¯
fgb() {
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        echo "éŒ¯èª¤: ä¸åœ¨ Git å€‰åº«ä¸­" >&2
        return 1
    fi

    local branch
    branch=$(git branch -a --color=always | \
        grep -v '/HEAD\s' | \
        sort | \
        fzf --ansi \
            --height=40% \
            --border \
            --prompt="é¸æ“‡åˆ†æ”¯: " \
            --preview="git log --oneline --graph --date=short --pretty='format:%C(auto)%cd %h%d %s' {1} | head -10" \
            --preview-window=right:50% \
            | sed 's/^..//' | sed 's#remotes/[^/]*/##')
    
    if [[ -n "$branch" ]]; then
        git checkout "$branch"
    fi
}

# fgl - ä½¿ç”¨ fzf ç€è¦½ Git æ—¥èªŒ
fgl() {
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        echo "éŒ¯èª¤: ä¸åœ¨ Git å€‰åº«ä¸­" >&2
        return 1
    fi

    git log --graph --color=always --format="%C(auto)%h%d %s %C(black)%C(bold)%cr" "$@" | \
        fzf --ansi --no-sort --reverse --tiebreak=index \
            --height=60% \
            --border \
            --prompt="Git æ—¥èªŒ: " \
            --preview="echo {} | grep -o '[a-f0-9]\{7\}' | head -1 | xargs -I % sh -c 'git show --color=always %'" \
            --preview-window=right:60% \
            --bind="enter:execute(echo {} | grep -o '[a-f0-9]\{7\}' | head -1 | xargs -I % sh -c 'git show %')"
}

# ============================================================================
# ç³»çµ±è³‡è¨Šå·¥å…·
# ============================================================================

# sysinfo - é¡¯ç¤ºç³»çµ±è³‡è¨Šæ‘˜è¦
sysinfo() {
    echo "ğŸ–¥ï¸  ç³»çµ±è³‡è¨Šæ‘˜è¦"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ’» ç³»çµ±: $(uname -s) $(uname -r)"
    echo "ğŸ—ï¸  æ¶æ§‹: $(uname -m)"
    echo "ğŸ§  CPU: $(sysctl -n machdep.cpu.brand_string 2>/dev/null || echo "æœªçŸ¥")"
    echo "ğŸ’¾ è¨˜æ†¶é«”: $(echo "scale=2; $(sysctl -n hw.memsize 2>/dev/null || echo 0) / 1024 / 1024 / 1024" | bc 2>/dev/null || echo "æœªçŸ¥") GB"
    echo "â° é‹è¡Œæ™‚é–“: $(uptime | awk -F'up ' '{print $2}' | awk -F', load' '{print $1}')"
    echo "ğŸŒ¡ï¸  è² è¼‰: $(uptime | awk -F'load averages: ' '{print $2}')"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

# ============================================================================
# å¹«åŠ©å‡½æ•¸
# ============================================================================

# fzf_help - é¡¯ç¤ºæ‰€æœ‰è‡ªå®šç¾© fzf å‡½æ•¸çš„å¹«åŠ©
fzf_help() {
    cat << 'EOF'
ğŸ” FZF å¢å¼·å·¥å…·é›†åˆ

ğŸ“ æª”æ¡ˆèˆ‡ç›®éŒ„:
  ff [pattern]     - æœå°‹ä¸¦é–‹å•Ÿæª”æ¡ˆ
  fcd [pattern]    - æœå°‹ä¸¦åˆ‡æ›ç›®éŒ„
  vg <pattern>     - æœå°‹æ–‡å­—å…§å®¹ä¸¦é–‹å•Ÿæª”æ¡ˆ

ğŸ–¥ï¸  TMUX ç®¡ç†:
  ftm [session]    - å‰µå»ºæˆ–åˆ‡æ› tmux session
  fs [pattern]     - å¿«é€Ÿåˆ‡æ› tmux session

ğŸ”§ ç¨‹åºç®¡ç†:
  fkill [signal]   - é¸æ“‡ä¸¦çµ‚æ­¢ç¨‹åº

ğŸ³ Docker å·¥å…·:
  fdim             - é¸æ“‡ä¸¦åˆªé™¤ Docker æ˜ åƒ
  fdc [action]     - ç®¡ç† Docker å®¹å™¨

ğŸŒ Git å·¥å…·:
  fgb              - é¸æ“‡ä¸¦åˆ‡æ› Git åˆ†æ”¯
  fgl              - ç€è¦½ Git æ—¥èªŒ

ğŸŒ ç¶²è·¯å·¥å…·:
  myip             - é¡¯ç¤º IP åœ°å€è³‡è¨Š

â„¹ï¸  ç³»çµ±è³‡è¨Š:
  sysinfo          - é¡¯ç¤ºç³»çµ±è³‡è¨Šæ‘˜è¦
  fzf_help         - é¡¯ç¤ºæ­¤å¹«åŠ©è³‡è¨Š

ğŸ’¡ æç¤º: å¤§éƒ¨åˆ†å‡½æ•¸æ”¯æ´å¤šé¸ (ä½¿ç”¨ Tab éµ) å’Œé è¦½åŠŸèƒ½
EOF
}
